{% extends "base.html" %}

{% block title %}Mis semanas - Habit Tracker{% endblock %}

{% block content %}
<h1>ğŸ“… Mis semanas</h1>

<div class="nav">
    <a href="/habitos">ğŸ“ˆ HÃ¡bitos</a>
    <a href="/semanas">ğŸ“… Semanas</a>
    <a href="/logout" style="margin-left: auto;">ğŸšª Salir</a>
</div>

{% set semana = usuario.ultima_semana() %}

{% if semana %}
    <h2>Semana actual</h2>
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div>
                <strong>Inicio:</strong> {{ semana.fecha_inicio.strftime('%d/%m/%Y') }}
            </div>
            <div>
                <span class="badge badge-completed">{{ semana.objetivos_completados|length }}/{{ semana.objetivos|length }} completados</span>
            </div>
        </div>
        
        {% if semana.objetivos %}
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ semana.progreso() * 100 }}%;"></div>
            </div>
            <div style="text-align: right; font-size: 0.875rem; color: #718096; margin-top: 4px;">
                {{ "%.0f"|format(semana.progreso() * 100) }}% completado
            </div>
        {% endif %}
    </div>

    <h3>ğŸ“‹ Objetivos de la semana</h3>
    {% if semana.objetivos %}
        {% for obj in semana.objetivos %}
            <div class="objetivo-item">
                <div style="flex: 1;">
                    {% if obj in semana.objetivos_completados %}
                        <span style="color: #38a169; font-weight: 600;">âœ…</span>
                    {% else %}
                        <span style="color: #cbd5e0;">â­•</span>
                    {% endif %}
                    <span {% if obj in semana.objetivos_completados %}style="text-decoration: line-through; color: #a0aec0;"{% endif %}>
                        {{ obj }}
                    </span>
                </div>
                {% if obj not in semana.objetivos_completados %}
                <div class="actions">
                    <form method="POST" autocomplete="off" action="/semana/objetivo/completar">
                        <input type="hidden" name="objetivo" value="{{ obj }}">
                        <button type="submit" class="btn-small btn-success">âœ… Completar</button>
                    </form>
                </div>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“</div>
            <p>Sin objetivos para esta semana</p>
        </div>
    {% endif %}

    <h3>â• AÃ±adir objetivo</h3>
    <form method="POST" autocomplete="off" action="/semana/objetivo/nuevo" style="display: flex; gap: 12px;">
        <input type="text" autocomplete="off" name="objetivo" placeholder="Nuevo objetivo para esta semana" required style="flex: 1; margin-bottom: 0;">
        <button type="submit">AÃ±adir</button>
    </form>

    <h3>ğŸ’­ ReflexiÃ³n de la semana</h3>
    <form method="POST" autocomplete="off" action="/semana/reflexion">
        <textarea autocomplete="off" name="reflexion" rows="5" placeholder="Â¿CÃ³mo ha ido la semana? Â¿QuÃ© has aprendido?">{{ semana.reflexion }}</textarea>
        <button type="submit" class="btn-success">ğŸ’¾ Guardar reflexiÃ³n</button>
    </form>

{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ“…</div>
        <p>No tienes ninguna semana creada</p>
        <p style="font-size: 0.875rem; margin-top: 8px;">Â¡Crea tu primera semana para empezar!</p>
    </div>
{% endif %}

<h2 style="margin-top: 40px;">ğŸš€ Crear nueva semana</h2>
<form method="POST" autocomplete="off" action="/semana/nueva">
    <div class="form-group">
        <label for="objetivos">Objetivos (uno por lÃ­nea)</label>
        <textarea autocomplete="off" id="objetivos" name="objetivos" rows="6" placeholder="Terminar proyecto X&#10;Hacer ejercicio 3 veces&#10;Leer 50 pÃ¡ginas"></textarea>
    </div>
    <button type="submit" style="width: 100%;">ğŸ“… Crear semana</button>
</form>

{% if semana %}
<p style="margin-top: 16px; padding: 12px; background: #fef5e7; border-left: 4px solid #f39c12; border-radius: 8px; font-size: 0.875rem; color: #7d6608;">
    <strong>Nota:</strong> Al crear una nueva semana, se archivarÃ¡ la actual y comenzarÃ¡s con objetivos en blanco.
</p>
{% endif %}

<!-- Historial de Semanas -->
{% if usuario.semanas|length > 1 %}
<h2 style="margin-top: 48px;">ğŸ“š Historial de Semanas</h2>
<p style="color: #718096; margin-bottom: 16px;">Revisa tus semanas anteriores y reflexiones pasadas</p>

{% for semana_historica in usuario.semanas[:-1]|reverse %}
    <div class="card" style="margin-bottom: 16px; {% if loop.index > 3 %}display: none;{% endif %}" id="semana-{{ loop.index }}">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div>
                <strong>ğŸ“… Semana del {{ semana_historica.fecha_inicio.strftime('%d/%m/%Y') }}</strong>
            </div>
            <div>
                <span class="badge badge-completed">
                    {{ semana_historica.objetivos_completados|length }}/{{ semana_historica.objetivos|length }} completados
                    ({{ "%.0f"|format(semana_historica.progreso() * 100) }}%)
                </span>
            </div>
        </div>
        
        {% if semana_historica.objetivos %}
            <div style="margin-top: 12px;">
                <strong style="color: #4a5568; font-size: 0.875rem;">Objetivos:</strong>
                <ul style="margin-top: 8px; margin-left: 20px; color: #718096; font-size: 0.875rem;">
                    {% for obj in semana_historica.objetivos %}
                        <li style="margin-bottom: 4px;">
                            {% if obj in semana_historica.objetivos_completados %}
                                <span style="color: #38a169;">âœ…</span> <span style="text-decoration: line-through;">{{ obj }}</span>
                            {% else %}
                                <span style="color: #cbd5e0;">â­•</span> {{ obj }}
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        
        {% if semana_historica.reflexion %}
            <div style="margin-top: 12px; padding: 12px; background: #f7fafc; border-radius: 8px; border-left: 3px solid #667eea;">
                <strong style="color: #4a5568; font-size: 0.875rem;">ğŸ’­ ReflexiÃ³n:</strong>
                <p style="margin-top: 8px; color: #718096; font-size: 0.875rem; font-style: italic;">
                    "{{ semana_historica.reflexion }}"
                </p>
            </div>
        {% endif %}
    </div>
{% endfor %}

{% if usuario.semanas|length > 4 %}
<div style="text-align: center; margin-top: 16px;">
    <button onclick="mostrarMasSemanasHistoricas()" id="btnMostrarMas" style="background: #718096;">
        Ver mÃ¡s semanas ({{ usuario.semanas|length - 4 }} anteriores)
    </button>
</div>

<script>
function mostrarMasSemanasHistoricas() {
    const semanas = document.querySelectorAll('[id^="semana-"]');
    semanas.forEach(semana => {
        semana.style.display = 'block';
    });
    document.getElementById('btnMostrarMas').style.display = 'none';
}
</script>
{% endif %}
{% endif %}

{% endblock %}